<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DERAL Leads Finder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115;--panel:#151924;--muted:#202636;--ink:#e7ebf4;--sub:#a7b0c0;--brand:#8b5cf6;--brand-2:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
      --radius:16px;--radius-sm:10px;--shadow:0 8px 30px rgba(0,0,0,.25)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#0d0f15 0%,#0b0d12 100%);color:var(--ink)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-badge{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;color:#0b0d12;font-weight:800;box-shadow:var(--shadow)}
    .h1{font-weight:700;letter-spacing:.2px}
    .sub{color:var(--sub);font-size:14px}

    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
    .controls{display:grid;gap:12px;padding:18px}
    .grid{display:grid;gap:12px}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.g-3{grid-template-columns:1fr}.g-2{grid-template-columns:1fr}}

    label{font-size:12px;color:var(--sub);display:block;margin-bottom:6px}
    select,input{width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.08);padding:12px 14px;background:#0e121b;color:var(--ink);outline:none}
    select:focus,input:focus{border-color:var(--brand)}

    .switcher{display:flex;gap:8px;background:#0a0d14;border:1px solid rgba(255,255,255,.08);padding:6px;border-radius:12px}
    .pill{flex:1;text-align:center;padding:10px;border-radius:10px;cursor:pointer;color:var(--sub);border:1px solid transparent;user-select:none}
    .pill.active{background:linear-gradient(180deg,#101629,#0f1422);color:var(--ink);border-color:rgba(255,255,255,.08)}

    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .btn{appearance:none;border:none;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#0b0d12;font-weight:700;padding:12px 16px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow)}
    .btn.secondary{background:#0e121b;color:var(--ink);border:1px solid rgba(255,255,255,.12);font-weight:600}
    .btn.ghost{background:transparent;color:var(--ink);border:1px dashed rgba(255,255,255,.2);font-weight:600}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;color:var(--sub);font-weight:600;text-align:left;padding:0 12px}
    tbody td{background:#0f1420;border:1px solid rgba(255,255,255,.06);padding:14px 12px;vertical-align:top}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}

    /* Wider phone + site columns */
    th.th-phone, td.td-phone { min-width: 160px; }
    th.th-site,  td.td-site  { min-width: 180px; }
    th.th-links, td.td-links { min-width: 140px; }

    .kpi{display:flex;gap:14px;flex-wrap:wrap;margin:16px 0}
    .kpi .card{flex:1;min-width:220px;background:#0f1420;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
    .muted{color:var(--sub)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);font-size:12px}

    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:4px 0}
    .help{font-size:12px;color:var(--sub)}
    a.link{color:#a5b4fc;text-decoration:none}
    a.link:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="logo-badge">D</div>
        <div>
          <div class="h1">DERAL Leads Finder</div>
          <div class="sub">Find boutiques, influencers, and exhibits — then export a clean list.</div>
        </div>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnSettings">API / Settings</button>
        <button class="btn" id="btnExport">Create List (CSV)</button>
      </div>
    </header>

    <!-- MODE SWITCHER -->
    <div class="panel" style="margin-bottom:12px">
      <div class="controls">
        <label>What are you looking for?</label>
        <div class="switcher" id="modeSwitcher">
          <div class="pill active" data-mode="boutique">Boutiques</div>
          <div class="pill" data-mode="influencer">Influencers</div>
          <div class="pill" data-mode="exhibit">Exhibits</div>
        </div>
        <div class="help">Tip: Filters below update based on the selection above.</div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="panel">
      <div class="controls grid g-3">
        <div>
          <label>Country</label>
          <select id="countrySelect"></select>
        </div>
        <div>
          <label>City</label>
          <select id="citySelect"><option value="">Select country first</option></select>
        </div>
        <div id="categoryWrap">
          <label>Category</label>
          <select id="categorySelect"></select>
        </div>

        <!-- Influencer-only -->
        <div class="influencer-only" style="display:none">
          <label>Followers (min)</label>
          <input type="number" id="minFollowers" placeholder="e.g., 5000" />
        </div>
        <div class="influencer-only" style="display:none">
          <label>Followers (max)</label>
          <input type="number" id="maxFollowers" placeholder="e.g., 50000" />
        </div>
        <div class="influencer-only" style="display:none">
          <label>Budget (min) <span id="budgetCur1" class="muted">USD</span></label>
          <input type="number" id="minBudget" placeholder="e.g., 200" />
        </div>
        <div class="influencer-only" style="display:none">
          <label>Budget (max) <span id="budgetCur2" class="muted">USD</span></label>
          <input type="number" id="maxBudget" placeholder="e.g., 1000" />
        </div>

        <!-- Exhibit-only -->
        <div class="exhibit-only" style="display:none">
          <label>Dates (from)</label>
          <input type="date" id="dateFrom" />
        </div>
        <div class="exhibit-only" style="display:none">
          <label>Dates (to)</label>
          <input type="date" id="dateTo" />
        </div>

        <div class="row" style="grid-column:1/-1;justify-content:flex-end;margin-top:4px">
          <button class="btn" id="btnSearch">Search</button>
          <button class="btn ghost" id="btnClear">Clear</button>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi">
      <div class="card"><div class="muted">Results</div><div id="kpiResults" style="font-weight:700;font-size:22px">0</div></div>
      <div class="card"><div class="muted">Mode</div><div id="kpiMode" style="font-weight:700">Boutiques</div></div>
      <div class="card"><div class="muted">Currency</div><div id="kpiCur" style="font-weight:700">USD</div></div>
    </div>

    <!-- RESULTS TABLE -->
    <div class="panel">
      <div class="controls">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:700">Results</div>
          <div class="help">Click a row to edit email/phone and (for influencers) deal & budget.</div>
        </div>
        <div class="divider"></div>
        <div style="overflow:auto">
          <table id="resultsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Location</th>
                <th class="th-rating">Rating</th>
                <th class="th-reviews">Reviews</th>
                <th class="th-phone">Phone</th>
                <th class="th-email">Email</th>
                <th class="th-site">Website</th>
                <th class="th-links">Links</th>
                <th class="th-cats">Categories</th>
                <th class="th-followers" style="display:none">Followers</th>
                <th class="th-deal" style="display:none">Deal Type</th>
                <th class="th-budget" style="display:none">Budget</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:20px">
      <div class="panel" style="max-width:720px;width:100%">
        <div class="controls grid g-2">
          <div style="grid-column:1/-1"><div style="font-weight:700">Settings & API Keys</div><div class="help">Keys are saved in your browser only. For production, keep secrets on a server/proxy.</div></div>
          <div>
            <label>Google Maps JavaScript API Key <span class="muted">(Places)</span></label>
            <input id="googleKey" placeholder="AIza..." />
          </div>
          <div>
            <label>Instagram / RapidAPI Key <span class="muted">(optional, for influencer lookup)</span></label>
            <input id="instaKey" placeholder="xxxx-xxxx-xxxx" />
          </div>
          <div class="row" style="grid-column:1/-1;justify-content:flex-end">
            <button class="btn secondary" id="btnCloseModal">Close</button>
            <button class="btn" id="btnSaveKeys">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="help" style="margin-top:16px">⚠️ Google Places rarely returns emails. Use the website to find a public email or fill it manually by clicking a row.</div>
  </div>

  <script>
    // ------- SIMPLE DATASETS -------
    const COUNTRIES = [
      // Israel (expanded)
      { code:'IL', name:'Israel', currency:'ILS', cities:[
        'Tel Aviv','Jerusalem','Haifa','Rishon LeZion','Petah Tikva','Netanya','Ashdod','Ashkelon',
        'Beersheba','Herzliya','Ramat Gan','Givatayim','Holon','Bat Yam','Rehovot','Kfar Saba',
        'Ra\'anana','Rosh HaAyin','Hadera','Nahariya','Eilat','Modi\'in-Maccabim-Re\'ut','Yokneam','Kiryat Ata'
      ]},
      // United States (expanded)
      { code:'US', name:'United States', currency:'USD', cities:[
        'New York','Los Angeles','Miami','Chicago','Dallas','San Francisco','Boston','Seattle','Atlanta','Austin',
        'Denver','Houston','Philadelphia','Washington','San Diego','Las Vegas','Phoenix','Orlando','Tampa','Portland',
        'Nashville','Charlotte','San Jose','Minneapolis','Detroit','New Orleans'
      ]},
      // UK
      { code:'GB', name:'United Kingdom', currency:'USD', cities:[
        'London','Manchester','Birmingham','Leeds','Liverpool','Bristol','Glasgow','Edinburgh','Brighton','Newcastle'
      ]},
      // France
      { code:'FR', name:'France', currency:'USD', cities:[
        'Paris','Lyon','Marseille','Nice','Bordeaux','Toulouse','Lille','Nantes','Montpellier','Cannes'
      ]},
      // Germany
      { code:'DE', name:'Germany', currency:'USD', cities:[
        'Berlin','Munich','Hamburg','Frankfurt','Cologne','Düsseldorf','Stuttgart','Leipzig','Dresden','Nuremberg'
      ]},
      // Italy
      { code:'IT', name:'Italy', currency:'USD', cities:[
        'Milan','Rome','Florence','Naples','Venice','Turin','Bologna','Verona','Genoa','Palermo'
      ]},
      // Spain
      { code:'ES', name:'Spain', currency:'USD', cities:[
        'Madrid','Barcelona','Valencia','Seville','Malaga','Bilbao','Zaragoza','Palma de Mallorca'
      ]},
      // Netherlands
      { code:'NL', name:'Netherlands', currency:'USD', cities:[
        'Amsterdam','Rotterdam','The Hague','Utrecht','Eindhoven','Haarlem'
      ]},
      // Greece
      { code:'GR', name:'Greece', currency:'USD', cities:[
        'Athens','Thessaloniki','Patras','Heraklion','Chania'
      ]},
      // Portugal
      { code:'PT', name:'Portugal', currency:'USD', cities:[
        'Lisbon','Porto','Braga','Coimbra','Faro'
      ]},
      // Switzerland
      { code:'CH', name:'Switzerland', currency:'USD', cities:[
        'Zurich','Geneva','Basel','Lausanne','Bern','Lugano'
      ]},
      // Austria
      { code:'AT', name:'Austria', currency:'USD', cities:[
        'Vienna','Salzburg','Innsbruck','Graz','Linz'
      ]},
    ];

    // Boutique categories via Google Places types (you can expand)
    const BOUTIQUE_CATS = ['clothing_store','shoe_store','jewelry_store','shopping_mall'];
    // Influencer categories (free text-ish)
    const INFLUENCER_CATS = ['fashion','beauty','lifestyle','motherhood','travel','fitness'];
    // Exhibits (free text)
    const EXHIBIT_CATS = ['fashion trade show','design fair','market','pop-up'];

    // ------- STATE -------
    const state = {
      mode:'boutique',
      currency:'USD',
      results:[],
      keys:{ google: localStorage.getItem('deral_google_key')||'', insta: localStorage.getItem('deral_insta_key')||'' },
    };

    // ------- INIT UI -------
    const countrySelect = document.getElementById('countrySelect');
    const citySelect = document.getElementById('citySelect');
    const categorySelect = document.getElementById('categorySelect');
    const budgetCur1 = document.getElementById('budgetCur1');
    const budgetCur2 = document.getElementById('budgetCur2');
    const kpiResults = document.getElementById('kpiResults');
    const kpiMode = document.getElementById('kpiMode');
    const kpiCur = document.getElementById('kpiCur');

    function fillCountries(){
      countrySelect.innerHTML = '<option value="">Select country</option>' + COUNTRIES.map(c=>`<option value="${c.code}">${c.name}</option>`).join('');
    }
    function fillCities(){
      const c = COUNTRIES.find(x=>x.code===countrySelect.value);
      if(!c){ citySelect.innerHTML = '<option value="">Select country first</option>'; return; }
      citySelect.innerHTML = '<option value="">Any city</option>' + c.cities.map(ci=>`<option>${ci}</option>`).join('');
    }
    function fillCategories(){
      let opts=[];
      if(state.mode==='boutique') opts = BOUTIQUE_CATS;
      if(state.mode==='influencer') opts = INFLUENCER_CATS;
      if(state.mode==='exhibit') opts = EXHIBIT_CATS;
      categorySelect.innerHTML = '<option value="">Any</option>' + opts.map(o=>`<option value="${o}">${o.replaceAll('_',' ')}</option>`).join('');
    }

    function updateCurrency(){
      const isIL = countrySelect.value==='IL';
      state.currency = isIL ? 'ILS' : 'USD';
      budgetCur1.textContent = state.currency; budgetCur2.textContent = state.currency; kpiCur.textContent = state.currency;
    }

    function setMode(mode){
      state.mode = mode; kpiMode.textContent = mode.charAt(0).toUpperCase()+mode.slice(1);
      document.querySelectorAll('.pill').forEach(p=>p.classList.toggle('active', p.dataset.mode===mode));
      document.querySelectorAll('.influencer-only').forEach(el=> el.style.display = (mode==='influencer')? 'block':'none');
      document.querySelectorAll('.exhibit-only').forEach(el=> el.style.display = (mode==='exhibit')? 'block':'none');
      const showInfluencerCols = mode==='influencer';
      document.querySelector('.th-followers').style.display = showInfluencerCols?'table-cell':'none';
      document.querySelector('.th-deal').style.display = showInfluencerCols?'table-cell':'none';
      document.querySelector('.th-budget').style.display = showInfluencerCols?'table-cell':'none';
      const showBoutiqueCols = mode!=='influencer';
      document.querySelector('.th-rating').style.display = showBoutiqueCols?'table-cell':'none';
      document.querySelector('.th-reviews').style.display = showBoutiqueCols?'table-cell':'none';
      fillCategories();
    }

    // ------- RESULTS RENDER -------
    const tbody = document.querySelector('#resultsTable tbody');
    function renderRows(){
      tbody.innerHTML = state.results.map((r,i)=>{
        const loc = [r.city,r.country].filter(Boolean).join(', ');
        const cats = (r.categories||[]).join(', ');
        const emailCell = r.email ? `<a class="link" href="mailto:${escapeHtml(r.email)}">${escapeHtml(r.email)}</a>` : '';
        const siteCell = r.website ? `<a class="link" href="${escapeHtml(r.website)}" target="_blank" rel="noopener">Website</a>` : '';
        const googleCell = r.google_url ? `<a class="link" href="${escapeHtml(r.google_url)}" target="_blank" rel="noopener">View on Google</a>` : '';
        return `<tr data-idx="${i}">
          <td>${escapeHtml(r.name||'')}</td>
          <td>${escapeHtml(loc)}</td>
          <td class="td-rating" style="${state.mode==='influencer'?'display:none':''}">${r.rating??''}</td>
          <td class="td-reviews" style="${state.mode==='influencer'?'display:none':''}">${r.user_ratings_total??''}</td>
          <td class="td-phone">${escapeHtml(r.phone||'')}</td>
          <td class="td-email">${emailCell}</td>
          <td class="td-site">${siteCell}</td>
          <td class="td-links">${googleCell}</td>
          <td>${escapeHtml(cats)}</td>
          <td class="td-followers" style="${state.mode==='influencer'?'':'display:none'}">${r.followers??''}</td>
          <td class="td-deal" style="${state.mode==='influencer'?'':'display:none'}">${escapeHtml(r.deal_type||'')}</td>
          <td class="td-budget" style="${state.mode==='influencer'?'':'display:none'}">${r.budget? formatCurrency(r.budget):''}</td>
        </tr>`
      }).join('');
      kpiResults.textContent = state.results.length;
      attachRowEditing();
    }

    function attachRowEditing(){
      tbody.querySelectorAll('tr').forEach(tr=>{
        tr.addEventListener('click',()=>{
          const idx = +tr.dataset.idx; const r = state.results[idx];
          const newEmail = prompt('Edit email (leave blank to keep):', r.email||''); if(newEmail!==null) r.email = newEmail.trim();
          const newPhone = prompt('Edit phone (leave blank to keep):', r.phone||''); if(newPhone!==null) r.phone = newPhone.trim();
          if(state.mode==='influencer'){
            const newDeal = prompt('Deal type (money / item+%)', r.deal_type||''); if(newDeal!==null) r.deal_type=newDeal.trim();
            const newBudget = prompt(`Budget in ${state.currency}`, r.budget||''); if(newBudget!==null && newBudget!=='') r.budget = Number(newBudget);
          }
          renderRows();
        })
      })
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])) }
    function formatCurrency(n){ try{ return new Intl.NumberFormat(undefined,{style:'currency',currency:state.currency}).format(n) }catch{ return n } }

    // ------- SEARCH -------
    document.getElementById('btnSearch').addEventListener('click', async ()=>{
      const country = countrySelect.value; const city = citySelect.value; const cat = categorySelect.value;
      if(!country){ alert('Please select a country'); return; }
      updateCurrency();
      if(state.mode==='boutique'){
        state.results = await searchBoutiques({country,city,cat});
      } else if(state.mode==='influencer'){
        const minF = +document.getElementById('minFollowers').value||0;
        const maxF = +document.getElementById('maxFollowers').value||Number.MAX_SAFE_INTEGER;
        const minB = +document.getElementById('minBudget').value||0;
        const maxB = +document.getElementById('maxBudget').value||Number.MAX_SAFE_INTEGER;
        state.results = await searchInfluencers({country,city,cat,minF,maxF,minB,maxB});
      } else if(state.mode==='exhibit'){
        const dateFrom = document.getElementById('dateFrom').value; const dateTo = document.getElementById('dateTo').value;
        state.results = await searchExhibits({country,city,cat,dateFrom,dateTo});
      }
      renderRows();
    });

    document.getElementById('btnClear').addEventListener('click',()=>{ state.results=[]; renderRows(); });

    async function searchBoutiques({country,city,cat}){
      if(state.keys.google){
        try {
          const real = await googlePlacesSearch({country,city,cat});
          if(real?.length) return real;
        } catch(e){ console.warn(e); }
      }// Google Places search for Exhibits / Pop-ups / Markets with pagination (up to ~60)
async function googleExhibitsSearch({country,city,cat,dateFrom,dateTo}){
  const key = state.keys.google; if (!key) return [];
  await loadGoogleMaps(key);

  return new Promise((resolve, reject)=>{
    try{
      const service = new google.maps.places.PlacesService(document.createElement('div'));

      // Build an exhibit-friendly query
      const queryParts = [];
      if (cat) {
        // e.g., "market", "pop-up", "fashion trade show"
        queryParts.push(cat);
      } else {
        // Broad terms to find markets/pop-ups/trade shows
        queryParts.push('fashion pop-up market trade show bazaar sample sale');
      }
      if (city) queryParts.push(city);
      queryParts.push(codeToName(country));

      const query = queryParts.join(' ');
      const all = [];

      // Filter out big chains / irrelevant venues
      const chainBlock = /(h&m|zara|uniqlo|gap|forever\s?21|primark|mango|bershka|pull\s?&\s?bear|stradivarius|old\s?navy|target|walmart|macys|bloomingdale|nordstrom)/i;

      const handlePage = (results, status, pagination) => {
        if (status !== google.maps.places.PlacesServiceStatus.OK || !results) {
          finalize(); return;
        }
        const filtered = results.filter(r => !chainBlock.test(r.name||''));
        all.push(...filtered);

        if (pagination && pagination.hasNextPage && all.length < 60) {
          setTimeout(()=> pagination.nextPage(), 1500); // required delay per Google docs
        } else {
          finalize();
        }
      };

      const finalize = async () => {
        const limited = all.slice(0, 60);
        const detailed = await Promise.all(limited.map(r=> new Promise(res=>{
          service.getDetails({
            placeId: r.place_id,
            fields: [
              'name','rating','user_ratings_total','types','formatted_phone_number',
              'website','address_components','url'
            ]
          }, det => {
            const parsed = {
              name: det?.name||r.name,
              rating: det?.rating||r.rating,
              user_ratings_total: det?.user_ratings_total||r.user_ratings_total,
              phone: det?.formatted_phone_number||'',
              email: '', // Google doesn't provide; keep editable in table
              website: det?.website||'',
              google_url: det?.url||'',
              categories: det?.types||r.types||[],
            };
            const comps = det?.address_components||[];
            const cityComp = comps.find(c=>c.types.includes('locality'))?.long_name
                          || comps.find(c=>c.types.includes('postal_town'))?.long_name
                          || '';
            const countryComp = comps.find(c=>c.types.includes('country'))?.long_name || '';
            parsed.city = cityComp; parsed.country = countryComp;
            res(parsed);
          });
        }))).then(arr => arr.filter(Boolean)));

        resolve(detailed);
      };

      service.textSearch({ query }, handlePage);
    } catch (e) {
      reject(e);
    }
  });
}

      // Google Places search for Exhibits / Pop-ups / Markets with pagination (up to ~60)
async function googleExhibitsSearch({country,city,cat,dateFrom,dateTo}){
  const key = state.keys.google; if(!key) return [];
  await loadGoogleMaps(key);

  return new Promise((resolve, reject)=>{
    try{
      const service = new google.maps.places.PlacesService(document.createElement('div'));

      // Build a women/fashion exhibit-friendly query
      // If user picked a category (e.g., "market", "pop-up"), use it; otherwise use broad terms
      const queryParts = [];
      if (cat) {
        queryParts.push(cat); // e.g., "market", "pop-up", "fashion trade show"
      } else {
        queryParts.push('fashion pop-up market trade show bazaar sample sale'); // broad exhibit-ish terms
      }
      if (city) queryParts.push(city);
      queryParts.push(codeToName(country));

      const query = queryParts.join(' ');
      const all = [];

      // Filter out big chains / irrelevant venues
      const chainBlock = /(h&m|zara|uniqlo|gap|forever\s?21|primark|mango|bershka|pull\s?&\s?bear|stradivarius|old\s?navy|target|walmart|macys|bloomingdale|nordstrom)/i;

      const handlePage = (results, status, pagination) => {
        if(status!==google.maps.places.PlacesServiceStatus.OK || !results){
          finalize(); return;
        }
        // Basic filtering by name to avoid big chains
        const filtered = results.filter(r => !chainBlock.test(r.name||''));
        all.push(...filtered);

        if (pagination && pagination.hasNextPage && all.length < 60) {
          setTimeout(()=> pagination.nextPage(), 1500); // required delay
        } else {
          finalize();
        }
      };
      const finalize = async () => {
        const limited = all.slice(0, 60);
        const detailed = await Promise.all(limited.map(r=> new Promise(res=>{
          service.getDetails({
            placeId: r.place_id,
            fields: [
              'name','rating','user_ratings_total','types','formatted_phone_number',
              'website','address_components','url'
            ]
          }, det => {
            const parsed = {
              name: det?.name||r.name,
              rating: det?.rating||r.rating,
              user_ratings_total: det?.user_ratings_total||r.user_ratings_total,
              phone: det?.formatted_phone_number||'',
              email: '', // Google doesn't provide; keep editable
              website: det?.website||'',
              google_url: det?.url||'',
              categories: det?.types||r.types||[],
            };
            const comps = det?.address_components||[];
            const cityComp = comps.find(c=>c.types.includes('locality'))?.long_name
                          || comps.find(c=>c.types.includes('postal_town'))?.long_name
                          || '';
            const countryComp = comps.find(c=>c.types.includes('country'))?.long_name || '';
            parsed.city = cityComp; parsed.country = countryComp;

            // Optional: de-emphasize malls/department stores for "exhibits"
            const unwantedTypes = new Set(['department_store','supermarket']);
            const hasUnwanted = (parsed.categories||[]).some(t => unwantedTypes.has(t));
            if (!hasUnwanted) res(parsed); else res(null);
          });
        })).then(arr => arr.filter(Boolean)));

        resolve(detailed);
      };

      service.textSearch({ query }, handlePage);
    }catch(e){ reject(e); }
  });
}
      // fallback demo
      return [
        { name:'Lumière Boutique', country:codeToName(country), city:city||'—', rating:4.6, user_ratings_total:128, phone:'+1 555-0100', email:'info@lumiereshop.com', website:'', google_url:'', categories:[cat||'clothing_store'] },
        { name:'Atelier Rue', country:codeToName(country), city:city||'—', rating:4.4, user_ratings_total:86, phone:'+1 555-0101', email:'hello@atelierrue.com', website:'', google_url:'', categories:[cat||'clothing_store'] },
      ];
    }

    async function searchInfluencers({country,city,cat,minF,maxF,minB,maxB}){
      const mock = [
        { name:'@style.with.noa', country:codeToName(country), city:city||'—', followers:38000, phone:'', email:'inbox@stylewithnoa.com', website:'', google_url:'', categories:[cat||'fashion'], deal_type:'item+%', budget:0 },
        { name:'@urban.eden', country:codeToName(country), city:city||'—', followers:92000, phone:'', email:'hi@urbaneden.co', website:'', google_url:'', categories:[cat||'lifestyle'], deal_type:'money', budget:1200 },
      ];
      return mock.filter(r=> r.followers>=minF && r.followers<=maxF && r.budget>=minB && r.budget<=maxB);
    }

async function searchExhibits({country,city,cat,dateFrom,dateTo}){
  // Use Google Places like boutiques, but with exhibit-friendly keywords
  if (state.keys.google) {
    try {
      const real = await googleExhibitsSearch({ country, city, cat, dateFrom, dateTo });
      if (real?.length) return real;
    } catch (e) {
      console.warn('Exhibit search failed, using mock:', e);
    }
  }
  // Fallback only if Google fails or no key set
  return [
    { name:'City Fashion Market', country:codeToName(country), city:city||'—', phone:'', email:'apply@citymarket.com', website:'', google_url:'', categories:[cat||'market'] },
    { name:'Modern Design Pop-Up', country:codeToName(country), city:city||'—', phone:'', email:'contact@modernpopup.org', website:'', google_url:'', categories:[cat||'pop-up'] },
  ];
}
  // Use Google Places like boutiques, but with exhibit-friendly keywords
  if(state.keys.google){
    try {
      const real = await googleExhibitsSearch({country,city,cat,dateFrom,dateTo});
      if (real?.length) return real;
    } catch(e){ console.warn('Exhibit search failed, using mock:', e); }
  }
  // Fallback only if Google fails or no key set
  return [
    { name:'City Fashion Market', country:codeToName(country), city:city||'—', phone:'', email:'apply@citymarket.com', website:'', google_url:'', categories:[cat||'market'] },
    { name:'Modern Design Pop-Up', country:codeToName(country), city:city||'—', phone:'', email:'contact@modernpopup.org', website:'', google_url:'', categories:[cat||'pop-up'] },
  ];
}

    function codeToName(code){ return COUNTRIES.find(c=>c.code===code)?.name||code }

    // ------- EXPORT -------
    document.getElementById('btnExport').addEventListener('click',()=>{
      if(!state.results.length){ alert('No results to export yet. Run a search first.'); return; }
      const headers = state.mode==='influencer'
        ? ['name','country','city','followers','deal_type','budget','phone','email','website','google_url','categories']
        : ['name','country','city','rating','user_ratings_total','phone','email','website','google_url','categories'];
      const rows = state.results.map(r=> headers.map(h=> Array.isArray(r[h])? r[h].join('|') : (r[h]??'')));
      const csv = [headers.join(','), ...rows.map(r=> r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`deral-${state.mode}-list.csv`; a.click(); URL.revokeObjectURL(url);
    });

    // ------- SETTINGS -------
    document.getElementById('btnSettings').addEventListener('click',()=>{
      document.getElementById('googleKey').value = state.keys.google;
      document.getElementById('instaKey').value = state.keys.insta;
      document.getElementById('modal').style.display='flex';
    });
    document.getElementById('btnCloseModal').addEventListener('click',()=>{ document.getElementById('modal').style.display='none' });
    document.getElementById('btnSaveKeys').addEventListener('click',()=>{
      state.keys.google = document.getElementById('googleKey').value.trim();
      state.keys.insta = document.getElementById('instaKey').value.trim();
      localStorage.setItem('deral_google_key', state.keys.google);
      localStorage.setItem('deral_insta_key', state.keys.insta);
      document.getElementById('modal').style.display='none';
      alert('Saved locally. Remember to restrict your keys!');
    });

    // ------- GOOGLE PLACES (women-focused, filtered, 3 pages) -------
    async function googlePlacesSearch({country,city,cat}){
      const key = state.keys.google; if(!key) return [];
      await loadGoogleMaps(key);
      return new Promise((resolve,reject)=>{
        try{
          const service = new google.maps.places.PlacesService(document.createElement('div'));
          const queryParts = [];

          // Women-focused query by default
          if(cat) queryParts.push(cat.replace('_',' '));
          else queryParts.push('women boutique clothing');

          if(city) queryParts.push(city);
          queryParts.push(codeToName(country));

          const query = queryParts.join(' ');
          const all = [];

          const chainBlock = /(h&m|zara|uniqlo|gap|forever\s?21|primark|mango|bershka|pull\s?&\s?bear|stradivarius|old\s?navy|target|walmart|macys|bloomingdale|nordstrom)/i;

          const handlePage = (results, status, pagination) => {
            if(status!==google.maps.places.PlacesServiceStatus.OK || !results){
              finalize(); return;
            }
            const filtered = results.filter(r => !chainBlock.test(r.name||''));
            all.push(...filtered);
            if (pagination && pagination.hasNextPage && all.length < 60) {
              // nextPage requires slight delay per Google docs
              setTimeout(()=> pagination.nextPage(), 1500);
            } else {
              finalize();
            }
          };

          const finalize = async () => {
            const limited = all.slice(0, 60);
            const detailed = await Promise.all(limited.map(r=> new Promise(res=>{
              service.getDetails({
                placeId:r.place_id,
                fields:['name','rating','user_ratings_total','types','formatted_phone_number','website','address_components','url']
              }, det=>{
                const parsed = {
                  name: det?.name||r.name,
                  rating: det?.rating||r.rating,
                  user_ratings_total: det?.user_ratings_total||r.user_ratings_total,
                  phone: det?.formatted_phone_number||'',
                  email: '', // Not provided by Google; keep editable
                  website: det?.website||'',
                  google_url: det?.url||'',
                  categories: det?.types||r.types||[],
                };
                const comps = det?.address_components||[];
                const cityComp = comps.find(c=>c.types.includes('locality'))?.long_name
                              || comps.find(c=>c.types.includes('postal_town'))?.long_name
                              || '';
                const countryComp = comps.find(c=>c.types.includes('country'))?.long_name || '';
                parsed.city = cityComp; parsed.country = countryComp;
                res(parsed);
              });
            })));
            resolve(detailed);
          };

          service.textSearch({ query }, handlePage);
        }catch(e){ reject(e) }
      });
    }

    function loadGoogleMaps(key){
      return new Promise((resolve,reject)=>{
        if(window.google?.maps?.places){ resolve(); return; }
        const s = document.createElement('script');
        s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places`;
        s.async = true; s.onerror = ()=>reject(new Error('Failed to load Google Maps'));
        s.onload = ()=> resolve();
        document.head.appendChild(s);
      })
    }

    // ------- LIFECYCLE -------
    document.querySelectorAll('#modeSwitcher .pill').forEach(p=> p.addEventListener('click',()=> setMode(p.dataset.mode)));
    countrySelect.addEventListener('change',()=>{ fillCities(); updateCurrency(); });

    fillCountries(); fillCities(); fillCategories(); updateCurrency(); renderRows();
  </script>
</body>
</html>

